@if (currentGameState && visiblePlayerState && playerState) {
  <div class="sticky-header">
    <app-season-info
      [currentSeason]="playerState.season"
      [playedCards]="isStartOfSeason ? [] : playerState.playedSeasonCards"
      [isEndOfSeason]="playerState.isEndOfSeason"
    />

    <app-goal-area
      [goals]="gameState.goals"
      [coins]="playerState.coins"
      [temporaryCoins]="visiblePlayerState.coins"
      [previousScores]="playerState.scores"
      [temporaryScores]="visiblePlayerState.scores"
      [currentSeason]="playerState.season"
    ></app-goal-area>
  </div>

  <ng-content></ng-content>

  <div class="content">
    @if (isStartOfGame) {
      <app-example-board [goals]="gameState.goals" />
    } @else {
      <app-game-board
        [currentBoardState]="playerState.boardState"
        [currentShapeToPlace]="showCurrentShape ? currentShapeToPlace : undefined"
        [conflictedCellIndices]="visiblePlayerState.conflictedCellIndices"
        [scoreInfos]="visiblePlayerState.scoreInfos"
        [seasonGoals]="playerState.seasonGoals"
        [isEndOfSeason]="playerState.isEndOfSeason && !!playerState.season"
        (positionChange)="onPositionChange($event)"
      />
    }

    <div class="controls-and-info" [class.is-start]="isStartOfGame">
      <div *ngIf="!isCurrentPlayer" class="other-player-info">
        <h2><i class="fa-solid fa-info-circle"></i> {{ playerState.player.name }}'s game board</h2>
        <button (click)="backToMyGame.emit()">Back to mine</button>
      </div>

      <app-next-shape
        *ngIf="isCurrentPlayer && playerState.cardToPlace && !isStartOfSeason && !playerState.isEndOfSeason && currentMove"
        [landscapeCard]="playerState.cardToPlace"
        [hasConflict]="visiblePlayerState.hasConflict"
        [untouchedBoardState]="playerState.boardState"
        [move]="currentMove"
        (moveChange)="onMoveChange($event)"
        (submit)="submitShape()"
      ></app-next-shape>

      <app-season-goals
        *ngIf="isCurrentPlayer && !isStartOfGame && playerState.season"
        [currentSeason]="playerState.season"
        [goals]="gameState.goals"
        [coins]="playerState.coins"
        [scores]="playerState.scores"
        [isStartOfSeason]="isStartOfSeason"
        [isEndOfSeason]="playerState.isEndOfSeason"
        (startSeason)="startSeason()"
        (endSeason)="endSeason.emit()"
      ></app-season-goals>

      <app-game-setup-info
        *ngIf="playerState.season"
        [isStartOfGame]="isStartOfGame"
        [goals]="gameState.goals"
        [seasonScores]="playerState.seasonScores"
        (startGame)="isStartOfGame = false"
      />

      <ng-container *ngIf="!playerState.season">
        <div class="end-score">
          <div>🎖️</div>
          <div>{{ totalEndScore }}</div>
        </div>

        <app-season-goals
          *ngFor="let seasonScore of playerState.seasonScores"
          [currentSeason]="seasonScore.season"
          [goals]="gameState.goals"
          [coins]="seasonScore.coins"
          [scores]="seasonScore.goalScores"
          [isEndOfGame]="true"
        ></app-season-goals>
      </ng-container>
    </div>
  </div>
} @else {
  <div class="loading">
    <i class="fa-solid fa-spinner fa-spin"></i>
  </div>
}
